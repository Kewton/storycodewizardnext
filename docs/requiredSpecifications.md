# 要求仕様書

## プロジェクト名称
StoryCodeWizard

## 目的
本プロジェクトの目的は、ストーリーベースの要件を用いて最適なコード生成をサポートするアプリケーションを提供することです。ユーザーの入力を基に、適切なプログラム言語を選択し、履歴管理およびダウンロード可能な実行結果を提供することで開発体験を向上させます。

## 機能要件

### 1. プロジェクト管理機能
- 新しいプロジェクトの作成
- プロジェクトのディレクトリパスの設定
- プロジェクトの履歴保存および削除
- プロジェクト一覧の表示と削除

### 2. コード生成機能
- ストーリーや要件を基にしたコード生成プロセスを提供
- 入力ウィジェットを用いて、対話的に要件を入力
- 選択可能なプログラミングモデル (例: `FastAPI`, `Streamlit`, `Next.js`)
- 利用可能なLLM（大規模言語モデル）の選択
  - 利用可能なモデル: `OpenAI GPTシリーズ`, `Claude (Anthropic)`, `Gemini`

### 3. 履歴管理機能
- 履歴をプロジェクトごとに閲覧可能
- 履歴の削除、ダウンロード機能
  - ダウンロード形式: Markdown (`Your Context` と `Agent Context`)

### 4. UI/UX
- Streamlitを利用したユーザーインターフェース
- ワイド画面レイアウトの利用
- タブを用いたページ構成
  - `Stroy2Code`: コード生成
  - `MyHistory`: 履歴表示と操作
  - `プロジェクト管理`: プロジェクト管理
- ユーザーに直感的な操作を提供

### 5. アラート機能
- プロジェクト作成時、ディレクトリパスが無効またはプロジェクト名未設定の場合、適切なエラーメッセージを表示
- 履歴削除前には確認を促すダイアログを表示

## 非機能要件

### 1. 可読性
- PythonコードはGoogleスタイル形式のDocstringを利用
- flake8によるコード規約遵守

### 2. 拡張性
- モジュール構成の明確化
- 将来的なプログラミングモデルやLLMモデルの追加を容易にする設計

### 3. テスト
- pytestを用いた包括的なテストを提供
- 例: `tests/test_chat.py` が `communicate` 関数の基本動作をカバー

### 4. ドキュメント
- ユーザー向けのREADMEおよび要求仕様書を用意
- `docs/`ディレクトリにドキュメントを格納

## 制約条件
- Streamlitを利用してフロントエンドを構築
- 開発環境はPython >= 3.9 の仮想環境を推奨
- SQLiteをデータベースとして採用


## 技術仕様
- **UI Framework**: CustomTkinter 5.2.0+
- **Python**: 3.8+
- **Database**: JSONベースローカルDB
- **LLM API**: OpenAI, Anthropic, Google Gemini（ストリーミング対応）
- **Markdown処理**: markdown、pygments（シンタックスハイライト）
- **ナビゲーション**: VS Code風アクティビティーサイドバー

## 新機能: VS Code風アクティビティーサイドバー

### ナビゲーション方式
- **左側サイドバー**: アイコンベースの機能切り替え
- **Story2Code**: 💬 アイコンでチャット機能へアクセス
- **MyHistory**: 📚 アイコンで履歴管理へアクセス
- **プロジェクト管理**: 📁 アイコンでプロジェクト管理へアクセス
- **アクティブ状態**: 選択中の機能が視覚的にハイライト表示

### ユーザー体験の向上
- **最大化されたコンテンツ表示**: タブビューを廃止し、メインエリアを最大活用
- **直感的なナビゲーション**: VS Codeライクなアイコンベース操作
- **高速な機能切り替え**: ワンクリックでの機能切り替え
- **視覚的フィードバック**: アクティブ状態の明確な表示

## 新機能: Markdown表示対応

### サポートする記法
- **見出し**: # ## ### #### ##### ######
- **強調**: **太字** *斜体* ~~取り消し線~~
- **リスト**: 箇条書き（-）、番号付きリスト（1.）
- **コードブロック**: ```言語名 および `インラインコード`
- **リンク**: [テキスト](URL)
- **引用**: > 引用文
- **水平線**: ---
- **表**: Markdown表記法

### 実装詳細
- HTMLレンダリングによる高品質な表示
- コードブロックのシンタックスハイライト
- レスポンシブデザイン対応
- ダークテーマ最適化

### 使用方法
LLMからの応答は自動的にMarkdown記法として解釈され、適切にレンダリングされます。従来のプレーンテキスト表示も引き続き利用可能です。

## 開発者向け情報

### カスタムテーマ
CustomTkinterのダークテーマをベースにカスタムカラーパレットを適用：
- プライマリ: #1f538d (ブルー)
- セカンダリ: #14375e (ダークブルー)
- アクセント: #1f538d (ライトブルー)
- 背景: #212121 (ダークグレー)
- **サイドバー**: #2d2d2d (ダークグレー、VS Code風)

### レイアウト設計指針
- **間隔統一**: 全てのコンポーネント間で一貫した間隔を使用
- **視覚的階層**: ラベル、入力フィールド、ボタンの明確な配置
- **レスポンシブ対応**: ウィンドウサイズ変更に対応した柔軟なレイアウト
- **縦スクロール対応**: 設定パネルでの適切なスクロール機能
- **データ同期**: コンテンツ間でのリアルタイムデータ更新
- **ストリーミング対応**: LLM応答のリアルタイム表示
- **Markdown対応**: 豊富な表現力を持つテキスト表示
- **VS Code風ナビゲーション**: 直感的なサイドバーベース操作

### イベントハンドリング
- 非同期LLM API呼び出し
- ストリーミングレスポンス処理
- リアルタイムUI更新
- ファイルドラッグ&ドロップ対応
- 自動データリフレッシュ機能
- Markdownリアルタイムレンダリング
- プロジェクト選択時のProgramming Type自動設定
- **アクティビティーサイドバーナビゲーション**

## プロジェクト管理機能

### プロジェクト設定
- **プロジェクト名**: 識別用の名前（編集不可）
- **プロジェクトパス**: ソースコードのディレクトリパス
- **プロジェクト説明**: プロジェクトの詳細説明
- **Programming Type**: プロジェクトで使用するプログラミング言語・フレームワーク（Next.js、FastAPI、CustomTkinter等）

### プロジェクト編集機能
- プロジェクトカードから直接編集可能
- プロジェクトパス、説明、Programming Typeの編集（名前は編集不可）
- 可変サイズダイアログ対応
- リアルタイム更新と全コンテンツ同期

### Programming Type連携機能
- プロジェクト作成時にProgramming Typeを選択
- Chat Configurationでプロジェクト選択時に自動的にProgramming Typeを設定
- プロジェクトごとに最適なプロンプトテンプレートを自動選択

## チャット履歴機能

### 履歴表示形式
- **実行時刻**: YYYY-MM-DD_HH:MM:SS形式で表示
- **実行モデル**: 使用されたLLMモデル名
- **フォント**: 視認性向上のため大きなフォントサイズを使用
- **レイアウト**: シンプルで見やすい2項目表示
- **Markdown表示**: 履歴の詳細表示でMarkdown記法対応

## LLMストリーミング機能

### リアルタイム応答表示
- **ストリーミング対応**: Claude、GPT、Geminiのストリーミング応答を表示
- **リアルタイム更新**: 応答テキストがリアルタイムで表示される
- **処理状態表示**: 実行中、完了状態の明確な表示
- **応答保存**: ストリーミング完了後に履歴として保存
- **Markdown対応**: ストリーミング中もMarkdown記法をリアルタイム解析・表示

## トラブルシューティング

### よくある問題
1. **APIキーエラー**: `secret_keys.py`の設定を確認
2. **データベースエラー**: `python initdatabase.py`を再実行
3. **UI表示問題**: CustomTkinterの最新版を確認
4. **レイアウト崩れ**: ウィンドウサイズを調整し、最小サイズ以上で使用
5. **ストリーミングエラー**: API接続とキー設定を確認
6. **Markdown表示エラー**: markdown、pygmentsライブラリのインストールを確認
7. **Programming Type連携エラー**: プロジェクト設定の整合性を確認
8. **サイドバーナビゲーションエラー**: ウィンドウサイズと表示設定を確認

### ログ出力
アプリケーションログは標準出力に表示されます。

## 従来のStreamlit版からの変更点

### 主な改善点
- **ネイティブデスクトップアプリ**: ブラウザ不要で直接実行
- **レスポンシブUI**: より高速で滑らかな操作感
- **ストリーミング対応**: リアルタイムLLM応答表示
- **Markdown表示対応**: 豊富な表現力でリッチなテキスト表示
- **VS Code風ナビゲーション**: 直感的なアクティビティーサイドバー
- **最大化されたコンテンツ表示**: タブビューからサイドバーへの移行
- **カスタマイズ性向上**: テーマ・レイアウトの柔軟な調整
- **ファイル管理**: ドラッグ&ドロップによる直感的なファイル操作
- **リアルタイム更新**: データベース変更の即座な反映
- **プロジェクト管理強化**: Programming Type管理と連携機能
- **履歴表示改善**: 見やすい実行時刻・モデル名表示
- **縦スクロール対応**: 全画面表示でも快適な操作性

### 機能移行対応表
| Streamlit機能 | CustomTkinter対応 | 新アーキテクチャ |
|--------------|------------------|------------------|
| st.tabs() | CTkTabview | **ActivitySidebar** |
| st.selectbox() | CTkComboBox | CTkComboBox |
| st.text_area() | CTkTextbox | CTkTextbox |
| st.button() | CTkButton | CTkButton |
| st.file_uploader() | カスタムFileUploader | カスタムFileUploader |
| st.dataframe() | Tkinter Listbox + カスタム表示 | Tkinter Listbox + カスタム表示 |
| st.download_button() | ファイルダイアログ + 保存処理 | ファイルダイアログ + 保存処理 |
| st.write_stream() | StreamingChatMessage (Markdown対応) | StreamingChatMessage (Markdown対応) |
| st.markdown() | **新規**: MarkdownRenderer | **新規**: MarkdownRenderer |
| タブナビゲーション | **新規**: ActivitySidebar | **VS Code風サイドバー** |

## 技術詳細
### ディレクトリ構成
- メインディレクトリ: `StoryCodeWizard`
- アプリ構成: `app` ディレクトリ配下に各種モジュールを分類
- 履歴データ: `./mydb/` ディレクトリで管理

### 使用ライブラリ
- 必須ライブラリは `requirements.txt` に記載済み
- 新規ライブラリ追加時は `pip install` コマンドを提供

### テスト
- pytestを用いてユニットテストを作成
- テスト実行コマンド:
  ```bash
  pytest
  ```